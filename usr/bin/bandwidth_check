#!/bin/bash

# Configured bandwidth limit below in GiB:
bandwidthlimit=500
# Do not change anything else unless you know what you are doing.

if [ "$1" == "-r" ]; then
/usr/bin/vnstat --reset
echo "Bandwidth reset."
exit 0
fi

traffic=`/usr/bin/vnstat --short`
processed=`echo "$traffic" | sed -n 4p`
totalbw=`echo $processed | awk '{ print $9 $10 }'`

if [ ! -z $(echo $totalbw | grep "GiB") ]; then

bwtotal=$(echo $totalbw | sed -e 's/.\<[a-zA-Z0-9]*[GiB]\>//g')
echo "Amount of bandwidth used: $totalbw"

do_check="true"

elif [ ! -z $(echo $totalbw | grep "TiB") ]; then

bwtotalprocessed=$(echo $totalbw | sed -e 's/.\<[a-zA-Z0-9]*[TiB]\>//g')
bwtotalprocessed2=$(echo `expr $bwtotalprocessed \* 1024`)
bwtotal=$(echo "$bwtotal")

do_check="true"

echo "Amount of bandwidth used: $totalbw"

else

echo "Amount of bandwidth used: $totalbw"
echo "Note: Check not performed as the bandwidth usage was insufficient."

fi

if [ "$do_check" = "true" ]; then

# Perform check.

if (($bandwidthlimit < $bwtotal)); then

# Bandwidth limit reached. Stop Syncthing.

echo "Bandwidth limit reached."
echo "Shutting down the Syncthing relay."

supervisorctl stop syncthingRelay

else

# Bandwidth limit has not been reached, do not stop Syncthing.

echo "Bandwidth limit has not been reached."

fi
fi

